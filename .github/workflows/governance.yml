name: Governance Automation

on:
  issues:
    types: [opened]
  pull_request_target:
    types: [opened]

permissions:
  issues: write
  pull-requests: write

jobs:
  welcome:
    name: Welcome New Contributors
    runs-on: ubuntu-latest
    steps:
      - name: Greet New Issue Creator
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const creator = issue.user.login;

            // Check if this is the user's first issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: creator,
              state: 'all'
            });

            if (issues.data.length === 1) {
              await github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ðŸ‘‹ Welcome @${creator}! Thank you for opening your first issue.\n\nThis project uses AI-native development practices. An AI agent may assist in triaging and responding to this issue.\n\nPlease ensure you've:\n- [ ] Searched for existing issues\n- [ ] Provided all requested information\n- [ ] Reviewed our [CONTRIBUTING.md](../CONTRIBUTING.md)\n\nA maintainer will review this shortly!`
              });
            }

      - name: Greet New PR Creator
        if: github.event_name == 'pull_request_target'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const creator = pr.user.login;

            // Check if this is the user's first PR
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: creator
            });

            if (prs.data.length === 1) {
              await github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ðŸŽ‰ Congratulations on your first Pull Request, @${creator}!\n\nThis project leverages AI agents for code review and verification. Your PR may receive automated feedback.\n\nPlease ensure:\n- [ ] You've read [CONTRIBUTING.md](../CONTRIBUTING.md)\n- [ ] Tests pass locally\n- [ ] Code follows project conventions\n\nThank you for contributing!`
              });
            }

  auto-label:
    name: Auto Label Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    steps:
      - name: Label Based on Content
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body ? issue.body.toLowerCase() : '';
            const labels = [];

            // Auto-label based on keywords
            if (title.includes('bug') || body.includes('bug')) {
              labels.push('bug');
            }
            if (title.includes('feature') || body.includes('enhancement')) {
              labels.push('enhancement');
            }
            if (title.includes('doc') || title.includes('documentation')) {
              labels.push('documentation');
            }
            if (title.includes('question') || body.includes('how to')) {
              labels.push('question');
            }

            // Add AI-related labels
            if (body.includes('langchain') || body.includes('agent')) {
              labels.push('ai-agent');
            }
            if (body.includes('mcp') || body.includes('model context protocol')) {
              labels.push('mcp');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }
