name: Release GSD Plugin

on:
  push:
    branches: [master]
    paths:
      # Source files (build outputs generated in CI)
      - '.claude/**'
      - '.agent/**'
      - 'scripts/build-*.sh'
      - 'CLAUDE.md'
      - 'release-please-config.json'
      - '.release-please-manifest.json'
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      # Component-specific outputs (release-please v4 monorepo format)
      release_created: ${{ steps.release.outputs['gsd-plugin--release_created'] }}
      tag_name: ${{ steps.release.outputs['gsd-plugin--tag_name'] }}
      version: ${{ steps.release.outputs['gsd-plugin--version'] }}
    steps:
      - name: Release Please
        uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Debug outputs
        run: |
          echo "release_created: ${{ steps.release.outputs['gsd-plugin--release_created'] }}"
          echo "tag_name: ${{ steps.release.outputs['gsd-plugin--tag_name'] }}"
          echo "version: ${{ steps.release.outputs['gsd-plugin--version'] }}"

  build-and-upload:
    needs: release-please
    if: |
      needs.release-please.outputs.release_created == 'true' ||
      github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Get release info
        id: release-info
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            # Extract version from tag (gsd-plugin-v1.3.0 -> 1.3.0)
            VERSION=$(echo "$TAG" | sed 's/gsd-plugin-v//')
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ needs.release-please.outputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "version=${{ needs.release-please.outputs.version }}" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.release-info.outputs.tag }}

      - name: Build artifacts
        run: make build

      - name: Create Plugin ZIP
        run: |
          cd gsd-plugin
          zip -r ../gsd-plugin-${{ steps.release-info.outputs.version }}.zip . \
            -x ".git/*" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x ".pytest_cache/*" \
            -x "node_modules/*" \
            -x ".env" \
            -x ".venv/*" \
            -x "*.log" \
            -x ".DS_Store"

      - name: Create Antigravity ZIP
        run: |
          cd antigravity-boilerplate
          zip -r ../antigravity-boilerplate-${{ steps.release-info.outputs.version }}.zip . \
            -x ".git/*" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x ".pytest_cache/*" \
            -x "node_modules/*" \
            -x ".env" \
            -x ".venv/*" \
            -x "*.log" \
            -x ".DS_Store"

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-info.outputs.tag }}
          files: |
            gsd-plugin-${{ steps.release-info.outputs.version }}.zip
            antigravity-boilerplate-${{ steps.release-info.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.release-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.release-info.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Assets**:" >> $GITHUB_STEP_SUMMARY
          echo "  - gsd-plugin-${{ steps.release-info.outputs.version }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "  - antigravity-boilerplate-${{ steps.release-info.outputs.version }}.zip" >> $GITHUB_STEP_SUMMARY
